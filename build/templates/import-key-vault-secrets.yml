parameters:
  azureServiceConnection: ''

steps:
  - task: AzureCLI@2
    displayName: 'Import secrets from Azure Key Vault'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

        $keyVaultName = ${{ variables['Arcus.KeyVault.Name'] }}
        $secretNames = @(
          ${{ variables['Arcus.AppInsights.InstrumentationKey.SecretName'] }},
          ${{ variables['Arcus.ServiceBus.TopicConnectionString.SecretName'] }},
          ${{ variables['Arcus.ServiceBus.Queue.ConnectionString.SecretName'] }},
          ${{ variables['Arcus.EventHubs.ConnectionString.SecretName'] }},
          ${{ variables['Arcus.StorageAccount.ConnectionString.SecretName'] }}
        )

        $secretNames | ForEach-Object {
          $secretName = $_ -replace '-', '_'
          $secretValue = az keyvault secret show --vault-name $keyVaultName --name $secretName --query value -o tsv
          Set-AzDevOpsVariable -Name $secretName -Value $secretValue -AsSecret
        }